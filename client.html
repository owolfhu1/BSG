<!DOCTYPE html>
<html lang="en-us">
<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>test test</title>

    <!-- socket io -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- socket io -->

    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <!-- jquery -->

    <!-- bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/darkly/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- bootstrap -->

    <style>
        #game_body{
            height:450px;
            width:950px;
            overflow: scroll;
        }
        #main_board{
            height:1525px;
            width:1750px;
            background-image: url("BSG_board.jpg");
            background-size: 1750px 1525px;
            position:relative;
        }
        #hand_container{
            height:200px;
            width:950px;
            overflow: scroll;
        }
        #player_hand{
            height:250px;
            position:relative;
        }
        #turnAlert{
            position:fixed;
            width:120px;
            height:35px;
            top:0px;
            left:325px;
            color:black;
            font-size:20px;
            background-color: white;
            border : solid black 2px;
            z-index:99;
        }
        #choicePanel{
            position:fixed;
            top:50px;
            left:500px;
            border : solid white 2px;
            background-color:black;
            z-index:99;
        }
        .playerPiece{
            border : solid white 2px;
        }
        .skillCard{
            border : solid black 2px;
        }
        .quorumCard{
            border : solid black 2px;
        }
        .characterCard{
            border : solid black 2px;
        }

        .cardSelected{
            border : solid lightgreen 2px;
        }
        .cardHover{
            border : solid white 2px;
        }


        .text-display{
            height: 250px;
            overflow-y: scroll;
        }

        .border{
            border : solid black 1px;
            border-radius: 10px;
        }

        .locationHighlight{
            border : solid white 2px;
        }

        #fuelCounter{

        }

    </style>

</head>
<body>
<div class="row">
    <div id="online" style="display: none">
        <!-- text area -->
        <div class="col-sm-3" style="margin-left:10px;padding-right:0px;">
            <!-- game data -->
            <div id="game_data" class="well text-display">
                <!-- game data from server goes here -->
            </div>
            <!-- game data -->
            <!-- game input -->
            <input id="game_input" type="text" class="form-control" placeholder="enter game commands here"/>
            <!-- game input -->
            <br/>
            <!-- chat -->
            <div id="chat" class="well text-display">
                <!-- chat from server goes here -->
            </div>
            <!-- chat -->
            <!-- chat input -->
            <input id="chat_input" type="text" class="form-control" placeholder="chat here"/>
            <!-- chat input -->
        </div>
        <!-- text area -->
    </div>

    <!-- body-->
    <div class="col-sm-8">
        <div id="game_body" class="well">
            <input id="username" type="text" placeholder="username" class="form-control"/>
            <button id="login" class="btn btn-success btn-lg btn-block">log in</button>
        </div>
        <div id='hand_container'><div id='player_hand'></div></div>
    </div>
    <!-- body -->

    <!--  -->

</div>

<script>
    //Prevent you from going back by mistake
    window.onbeforeunload = function() { return ""; };

    let socket = io();
    let name = 'error';
    let chat = document.getElementById('chat');
    let chat_input = document.getElementById('chat_input');
    let game_body = document.getElementById('game_body');
    let online = document.getElementById('online');
    let username = document.getElementById('username');
    let login = document.getElementById('login');
    let game_input = document.getElementById('game_input');
    let game_data = document.getElementById('game_data');
    //let something = document.getElementById('something');

    let activateLocation = function(){
        socket.emit('game_text', 'activate');
    };

    let clickLocation = function(loc){
        socket.emit('game_text', locationToEnum[loc]);
    };

    let clickSkillCard = function(num){
        socket.emit('game_text', ("hand "+num));
    };

    let clickCharacterCard = function(character){
        socket.emit('game_text', character);
    };

    let clickNuke = function(character){
        socket.emit('game_text', "nuke");
    };

    let clickShip = function(area,num){
        socket.emit('game_text', area+" "+num);
    };

    let submitCrisis = function(){
        let selected="";
        $(".skillCard").each(
            function (index) {
                if($(this).hasClass("cardSelected")){
                    selected+=" "+index;
                }
            },
        );
        if(selected===""){
            selected="pass";
        }else{
            selected=selected.substr(1);
        }
        socket.emit('game_text', selected);
    };

    let submitChoice = function(choice){
        socket.emit('game_text', choice);
    };

    let spaceAreaToCoords ={
        "Northeast":[890,445,330,215],
        "East":[1400,600,150,565],
        "Southeast":[888,1120,380,200],
        "Southwest":[480,1120,380,200],
        "West":[195,615,85,515],
        "Northwest":[530,445,330,215],
    };

    let spaceAreaToEnum ={
        "Northeast":"NE",
        "East":"E",
        "Southeast":"SE",
        "Southwest":"SW",
        "West":"W",
        "Northwest":"NW",
    };

    let shipTypeToGraphic = {
        "Viper":"Viper.png",
        "Basestar":"BSG_basestar_01.gif",
        "Raider":"BSG_Raider.gif",
        "Heavy Raider":"BSG_HeavyRaider.gif",
        "Civilian":"BSG_ship_bk.gif",
    };

    let shipTypeToSize = {
        "Viper":[46,23],
        "Basestar":[134,70],
        "Raider":[29,22],
        "Heavy Raider":[67,20],
        "Civilian":[63,31],
    };

    let locationToEnum = {
        //Colonial One
        "Press Room":"PRESS_ROOM",
        "President's Office":"PRESIDENTS_OFFICE",
        "Administration":"ADMINISTRATION",

        //Cylon Locations
        "Caprica":"CAPRICA",
        "Cylon Fleet":"CYLON_FLEET",
        "Human Fleet":"HUMAN_FLEET",
        "Resurrection Ship":"RESSURRECTION_SHIP",

        //Galactica
        "FTL Control":"FTL_CONTROL",
        "Weapons Control":"WEAPONS_CONTROL",
        "Communications":"COMMUNICATIONS",
        "Research Lab":"RESEARCH_LAB",
        "Command":"COMMAND",
        "Admiral's Quarters":"ADMIRALS_QUARTERS",
        "Hangar Deck":"HANGAR_DECK",
        "Armory":"ARMORY",
        "Sickbay":"SICKBAY",
        "Brig":"BRIG",

    };

    let locationCoords = {
        //Colonial One
        "Press Room":[345,235],
        "President's Office":[480,235],
        "Administration":[605,235],

        //Cylon Locations
        "Caprica":[897,252],
        "Cylon Fleet":[992,252],
        "Human Fleet":[1088,252],
        "Resurrection Ship":[1184,252],

        //Galactica
        "FTL Control":[447,805],
        "Weapons Control":[596,721],
        "Communications":[744,721],
        "Research Lab":[894,721],
        "Command":[596,890],
        "Admiral's Quarters":[738,889],
        "Hangar Deck":[894,891],
        "Armory":[1042,807],
        "Sickbay":[1192,723],
        "Brig":[1186,894],
    };

    //receives chat and game_text from server and prints it in chat div
    socket.on('chat', text => {
        chat.innerHTML += text;
        chat.scrollTop = chat.scrollHeight;
    });
    socket.on('game_text', text => {
        game_data.innerHTML += text;
        game_data.scrollTop = game_data.scrollHeight;
    });

    //sends chat when enter is pressed in chat input
    chat_input.addEventListener('keyup', event => {
        event.preventDefault();
        if (event.keyCode === 13) {
            let text = chat_input.value;
            chat_input.value = '';
            socket.emit('chat', `${name}: ${text}</p>`);
        }
    });
    game_input.addEventListener('keyup', event => {
        event.preventDefault();
        if (event.keyCode === 13) {
            let text = game_input.value;
            game_input.value = '';
            socket.emit('game_text', text);
        }
    });

    //attempts to login on click
    login.addEventListener('click', () => {
        if (username.value.split(' ').length === 1 && username.value !== '' && username.value.length < 15)
            socket.emit('login', username.value);
    });

    //what to do when server says login
    socket.on('login', loginName => {
        name = loginName;
        online.style.display = 'inherit';
        game_body.innerHTML = "";
    });

    socket.on('lobby', tables => {
        let tablesHTML = `
            <button id="new_table" class="btn btn-lg btn-success btn-block">
                Click here to start a new table
            </button><br/><br/>
        `;
        //make a well for each table with basic info and a button to join it.
        for (let key in tables) {
            let players = '';
            for (let x = 0; x < tables[key].players.length; x++){
                players += `${x + 1}) ${tables[key].players[x].username} <br/>`;
            }
            tablesHTML += `
                <div class="well border">
                    <h1>${tables[key].host}'s table</h1>
                    ${players}
                    <button id="${tables[key].host}" class="btn btn-lg btn-primary btn-block">join table</button>
                </div>
            `;
        }
        game_body.innerHTML = tablesHTML;
        //activate join buttons
        for (let key in tables)
            $(`#${tables[key].host}`).click(() => socket.emit('join_table', key));
        //activate new table button
        $('#new_table').click(() => socket.emit('new_table'));
    });

    socket.on('table', table => {
        let tableHTML = `
            <h1>Welcome to ${table.host}'s table!</h1>
        `;
        //for each player at the table, print the name and if it
        //is the player using the client make a button else display if they are ready or not
        let players = '';
        for (let x = 0; x < table.players.length; x++) {
            players += `${x + 1}) ${table.players[x].username} : `;
            if (table.players[x].ready)
                players += `${name === table.players[x].username ?
                    `<button id="ready" class="btn btn-xs btn-default">ready</button>` : `ready`}`;
            else
                players += `${name === table.players[x].username ?
                    `<button id="ready" class="btn btn-xs btn-default">not ready</button>` : `not ready`}`;
            players += '<br/>';
        }
        tableHTML += players;
        game_body.innerHTML = tableHTML;

        $('#ready').click(() => socket.emit('ready'));

    });

    socket.on('clear', () => game_body.innerHTML = "<div id='main_board'></div>");

    socket.on('gameState', gameState => {
        gameState=JSON.parse(gameState);
        let main_board = document.getElementById('main_board');
        let player_hand = document.getElementById('player_hand');
        let board="<div id='main_board'>";
        board+="<div id=\"fuelCounter\" style=\"position:absolute;height:164px;width:164px;left:877px;top:23px;background-size:164px 164px;background-image:url('fuel"+gameState['fuelAmount']+".png');\"></div>";
        board+="<div id=\"foodCounter\" style=\"position:absolute;height:164px;width:164px;left:1047px;top:23px;background-size:164px 164px;background-image:url('fuel"+gameState['foodAmount']+".png');\"></div>";
        board+="<div id=\"moraleCounter\" style=\"position:absolute;height:164px;width:164px;left:1217px;top:25px;background-size:164px 164px;background-image:url('fuel"+gameState['moraleAmount']+".png');\"></div>";
        board+="<div id=\"populationCounter\" style=\"position:absolute;height:164px;width:164px;left:1390px;top:25px;background-size:164px 164px;background-image:url('fuel"+gameState['populationAmount']+".png');\"></div>";
        for(let i=0;i<gameState['raptorsInHangar'];i++){
            board+="<div class=\"raptor\" style=\"position:absolute;height:31px;width:50px;left:"+(570+(i*55))+"px;top:50px;background-size:50px 31px;background-image:url('BSG_Raptor.png');\"></div>";
        }
        for(let i=0;i<Math.min(gameState['vipersInHangar'],4);i++){
            board+="<div class=\"viper\" style=\"position:absolute;height:23px;width:46px;left:"+(575+(i*50))+"px;top:100px;background-size:46px 23px;background-image:url('Viper.png');\"></div>";
        }
        for(let i=0;i<Math.min(gameState['vipersInHangar']-4,8);i++){
            board+="<div class=\"viper\" style=\"position:absolute;height:23px;width:46px;left:"+(575+(i*50))+"px;top:150px;background-size:46px 23px;background-image:url('Viper.png');\"></div>";
        }
        for(let i=0;i<4;i++){
            for(let j=0;j<Math.min(gameState['damagedVipers']-(2*i),2);i++) {
                board += "<div class=\"viper\" style=\"position:absolute;height:23px;width:46px;left:" + (355 + (j * 50)) + "px;top:"+(50 + (i * 50))+";background-size:46px 23px;background-image:url('Viper.png');\"></div>";
            }
        }
        for(let i=0;i<gameState['centurionTrack'].length;i++){
            for(let j=0;j<gameState['centurionTrack'][i];j++) {
                board += "<div class=\"centurion\" style=\"position:absolute;height:78px;width:50px;left:"+(1292 + (i * 42))+"px;top:"+(325 + (j * 10))+"px;background-size:50px 78px;background-image:url('BSG_Boarding_Party.png');\"></div>";
            }
        }
        for(let loc in locationCoords){
            board+="<div onclick=\"clickLocation('"+loc+"');\" class=\"locationHotspot\" style=\"position:absolute;height:132px;width:100px;left:"+(locationCoords[loc][0])+"px;top:"+(locationCoords[loc][1])+"px;\"></div>"
        }

        let atLocation=[];
        for(let i=0;i<gameState['playerLocations'].length;i++){
            if(gameState['playerLocations'][i][0]==null){
                continue;
            }
            if(atLocation[gameState['playerLocations'][i][0]]==null) {
                atLocation[gameState['playerLocations'][i][0]]=0;
            }
            board += "<div class=\"playerPiece\" style=\"position:absolute;height:85px;width:58px;left:"+(locationCoords[gameState['playerLocations'][i][0]][0]+25)+"px;top:"+(locationCoords[gameState['playerLocations'][i][0]][1]-15+(20*atLocation[gameState['playerLocations'][i][0]]))+"px;background-size:58px 85px;background-image:url('"+gameState['playerLocations'][i][1]+"');\"></div>";
            atLocation[gameState['playerLocations'][i][0]]++;
        }
        if(gameState['activeLocation']!=null&&gameState['activeLocation']!==-1){
            board += "<button type=\"button\" onclick=\"activateLocation();\" class=\"activateLocationButton\"  style=\"position:absolute;left:"+(locationCoords[gameState['activeLocation']][0]+20)+"px;top:"+(locationCoords[gameState['activeLocation']][1]+130)+"px;background-color:green;\">Activate</button>";
        }

        for(let spaceArea in spaceAreaToCoords){
            board+="<div id=\"Space_"+spaceArea+"\" style=\"position:absolute;height:"+(spaceAreaToCoords[spaceArea][3])+"px;width:"+(spaceAreaToCoords[spaceArea][2])+"px;left:"+(spaceAreaToCoords[spaceArea][0])+"px;top:"+(spaceAreaToCoords[spaceArea][1])+"px;\">";
            for(let i=0;i<gameState['spaceAreas'][spaceArea].length;i++){
                board+="<div id=\"Ship_"+spaceArea+"_"+i+"\" class=\"ship\" style=\"margin:5px;height:"+(shipTypeToSize[gameState['spaceAreas'][spaceArea][i][0]][1])+"px;width:"+(shipTypeToSize[gameState['spaceAreas'][spaceArea][i][0]][0])+"px;background-size:100% 100%;background-image:url('"+shipTypeToGraphic[gameState['spaceAreas'][spaceArea][i][0]]+"');\"></div>";
            }

            board+="</div>";
        }


        if(gameState['gamePhase']==="Skill Check"){
            board+="<div id=\"choicePanel\">" +
                "<div class=\"crisisCard\" style=\"margin:10px;height:288px;width:183px;left:0px;top:0px;background-size:183px 288px;background-image:url('BSG_crisis_back.png');\"></div>";
            if(gameState['active']) {
                board += "<button type=\"button\" onclick=\"submitCrisis();\" class=\"submitCrisisButton\"  style=\"position:relative;margin-bottom:10px;left:25px;top:5px;background-color:green;\">Add <span id='crisisCardsSelected'>0</span> cards to Crisis</button>";
            }
            board+="</div>";

        }else if(gameState['gamePhase']==="Make a choice"){
            board+="<div id=\"choicePanel\">" +
                "<div class=\"crisisCard\" style=\"margin:10px;height:288px;width:183px;left:0px;top:0px;background-size:183px 288px;background-image:url('BSG_crisis_back.png');\"></div>";
            if(gameState['active']) {
                board+="<div style=\"position:relative;margin-bottom:10px;left:0px;top:0px;\">";
                board += "<button type=\"button\" onclick=\"submitChoice('1');\" class=\"submitCrisisButton\"  style=\"position:relative;margin-left:10px;top:5px;background-color:green;\">First</button>";
                board += "<button type=\"button\" onclick=\"submitChoice('2');\" class=\"submitCrisisButton\"  style=\"position:relative;margin-left:10px;top:5px;background-color:green;\">Second</button>";
                board+="</div>";
            }
            board+="</div>";

        }else if(gameState['gamePhase']==="Lee Adama Starting Launch"||gameState['gamePhase']==="Pick Launch Location"){
            board+="<div id=\"choicePanel\">";
            if(gameState['active']) {
                board+="<div style=\"position:relative;margin-bottom:10px;left:0px;top:0px;\">";
                board += "<button type=\"button\" onclick=\"submitChoice('0');\" class=\"submitCrisisButton\"  style=\"position:relative;margin-left:10px;top:5px;background-color:green;\">Launch Southwest</button>";
                board += "<button type=\"button\" onclick=\"submitChoice('1');\" class=\"submitCrisisButton\"  style=\"position:relative;margin-left:10px;margin-right:5px;top:5px;background-color:green;\">Launch Southeast</button>";
                board+="</div>";
            }
            board+="</div>";
        }else if(gameState['gamePhase']==="Pick Research Card"&&gameState['active']){
            board+="<div id=\"choicePanel\"><div style=\"position:relative;margin-bottom:10px;left:0px;top:0px;\">";
            board+="<button type=\"button\" onclick=\"submitChoice('0');\" class=\"submitCrisisButton\"  style=\"position:relative;margin-left:10px;top:5px;background-color:green;\">Engineering</button>";
            board+="<button type=\"button\" onclick=\"submitChoice('1');\" class=\"submitCrisisButton\"  style=\"position:relative;margin-left:10px;margin-right:5px;top:5px;background-color:green;\">Tactics</button>";
            board+="</div></div>";
        }


        board+="</div>";
        game_body.innerHTML = board;
        let hand="";
        if(gameState['active']){
            hand+="<div id='turnAlert'>It's your turn</div>";
        }

        let handTotalLeft=10;
        if(gameState['availableCharacters'].length>0){
            for(let i=0;i<gameState['availableCharacters'].length;i++){
                hand += "<div id=\"characterCard_"+gameState['availableCharacters'][i][0]+"\" class=\"characterCard\" style=\"position:absolute;height:301px;width:450px;left:"+(handTotalLeft)+"px;top:5px;background-size:450px 301px;background-image:url('"+gameState['availableCharacters'][i][1]+"');\"></div>";
                handTotalLeft+=460;
            }
        }


        for(let i=0;i<gameState['hand'].length;i++){
            hand += "<div id=\"skillCard_"+i+"\" class=\"skillCard\" style=\"position:absolute;height:210px;width:137px;left:"+(handTotalLeft)+"px;top:90px;background-size:133px 206px;background-image:url('"+gameState['hand'][i]+"');\"></div>";
            handTotalLeft+=143;
        }
        if(gameState['quorumHand'].length>0){
            handTotalLeft+=25;
            for(let i=0;i<gameState['quorumHand'].length;i++){
                hand += "<div class=\"quorumCard\" style=\"position:absolute;height:292px;width:187px;left:"+(handTotalLeft)+"px;top:10px;background-size:183px 288px;background-image:url('"+gameState['quorumHand'][i]+"');\"></div>";
                handTotalLeft+=272;
            }
        }
        if(gameState['nukes']>0) {
            handTotalLeft+=50;
            for (let i = 0; i < gameState['nukes']; i++) {
                hand += "<div class=\"nuke\" style=\"position:absolute;height:91px;width:105px;left:" + (handTotalLeft) + "px;top:100px;background-size:104px 91px;background-image:url('BSG_035.png');\"></div>";
                handTotalLeft += 130;
            }
        }


        player_hand.innerHTML = hand;

        $(".characterCard").click(
            function () {
                let id=$(this).attr('id').split("_")[1];
                $(this).click(clickCharacterCard(id));
            },
        );
        if(gameState['gamePhase']!=="Skill Check") {
            $(".skillCard").click(
                function (index) {
                    let id = $(this).attr('id').split("_")[1];
                    $(this).click(clickSkillCard(id));
                },
            );
        }

        $(".nuke").click(
            function (index) {
                $(this).click(clickNuke());
            },
        );

        $(".ship").click(
            function () {
                let id=$(this).attr('id').split("_");
                $(this).click(clickShip(spaceAreaToEnum[id[1]],id[2]));
            },
        );

        $(".skillCard, .quorumCard, .characterCard").hover(
            function () {
                $(this).addClass("cardHover");
            },
            function () {
                $(this).removeClass("cardHover");
            }
        );

        $(".locationHotspot").hover(
            function () {
                if(gameState['canMove']) {
                    //$(this).addClass("locationHighlight");
                    $(this).html("&nbsp;Click to Move");
                }

            },
            function () {
                if(gameState['canMove']) {
                    //$(this).removeClass("locationHighlight");
                    $(this).html("");
                }
            }
        );

        if(gameState['gamePhase']==="Skill Check"){
            $(".skillCard").click(
                function () {
                    $(this).toggleClass("cardSelected");
                    $("#crisisCardsSelected").html($(".cardSelected").length);
                },
            );
        }else{
            $(".skillCard").each(
                function () {
                    $(this).removeClass("cardSelected");
                },
            );
        }



    });

</script>


</body>
</html>











